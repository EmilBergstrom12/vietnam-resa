<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

  <title>Valuta ‚Äì VND ‚áÑ SEK</title>
  <style>
    body{
      margin:0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #fdfbfb, #ebedee);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:1rem;
    }
button, .btn, .quick-btn, input, select, a {
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
}

    .container{
      background:#fff;
      width:100%;
      max-width:820px;
      border-radius:18px;
      padding:2rem 1.5rem;
      box-shadow:0 15px 40px rgba(0,0,0,0.08);
    }
    h1{ margin:0 0 .25rem 0; font-size:1.4rem; }
    .sub{ color:#666; font-size:.95rem; margin:0 0 1rem 0; }

    .nav{
      display:flex; flex-wrap:wrap; gap:.5rem;
      margin:.75rem 0 1.25rem 0;
    }
    .nav a{
      text-decoration:none;
      font-size:.82rem;
      color:#1d4ed8;
      background:#eef4ff;
      padding:.32rem .6rem;
      border-radius:999px;
      border:1px solid #dbe7ff;
    }

    .card{
      background:#f8fafc;
      border:1px solid #eef1f6;
      border-radius:14px;
      padding:1rem;
    }

    .grid{
      display:grid;
      grid-template-columns:1fr;
      gap:.75rem;
    }
    @media (min-width: 700px){
      .grid{ grid-template-columns: 1fr 1fr; }
    }

    label{ display:block; font-weight:600; font-size:.9rem; margin-bottom:.35rem; color:#0f172a;}
    input{
      width:100%;
      font-size:1.25rem;
      padding:.7rem .8rem;
      border-radius:12px;
      border:1px solid #e5e7eb;
      outline:none;
      background:#fff;
      font-variant-numeric: tabular-nums;
    }
    input:focus{ border-color:#93c5fd; box-shadow:0 0 0 3px rgba(59,130,246,0.12); }

    .hint{ font-size:.82rem; color:#64748b; margin-top:.35rem; line-height:1.35; }

    .row{
      display:flex;
      flex-wrap:wrap;
      gap:.5rem;
      margin-top:.75rem;
      align-items:center;
      justify-content:space-between;
    }

    .markup{min-width:170px;max-width:220px}
    .markup label{font-size:.82rem;color:#475569;margin:0 0 .25rem 0}
    .markup input{padding:.55rem .7rem}
    .markup .hint{font-size:.75rem;color:#64748b;margin-top:.25rem;line-height:1.25}


    .btns{ display:flex; flex-wrap:wrap; gap:.5rem; }
    button{
      cursor:pointer;
      border-radius:999px;
      border:1px solid #e5e7eb;
      background:#fff;
      padding:.35rem .65rem;
      font-size:.82rem;
      color:#0f172a;
    }
    button:hover{ filter:brightness(.98); }
    .primary{
      border-color:#dbe7ff;
      background:#eef4ff;
      color:#1d4ed8;
    }

    .rate{
      margin-top:.75rem;
      font-size:.88rem;
      color:#334155;
      line-height:1.4;
    }
    .rate strong{ font-variant-numeric: tabular-nums; }

    .mini{
      margin-top:.5rem;
      font-size:.82rem;
      color:#64748b;
    }
.quick-btn {
  font-size: 1rem;          /* st√∂rre text */
  font-weight: 800;
  padding: 0.8rem 1rem;     /* st√∂rre klickyta */
  border-radius: 14px;
  min-height: 48px;         /* bra f√∂r mobil */
  min-width: 92px;          /* g√∂r dem ‚Äúchunky‚Äù */
  border: 1px solid #dbe7ff;
  background: #eef4ff;
  color: #1d4ed8;
  cursor: pointer;
}

@media (min-width: 760px) {
  .quick-btn {
    font-size: 1.05rem;
    padding: 0.85rem 1.1rem;
    min-width: 110px;
  }
}


    .toast{
      margin-top:.75rem;
      font-size:.85rem;
      color:#166534;
      display:none;
    }
    .toast.show{ display:block; }

    .divider{ height:1px; background:#eef1f6; margin:1.1rem 0; }
  </style>
</head>
<body>
  <main class="container">
    <h1>üí± Valuta ‚Äì VND ‚áÑ SEK</h1>
	

    <p class="sub">Skriv in VND eller SEK. Stora tal blir l√§ttare med automatisk formatering.</p>

    <nav class="nav">
      <a href="index.html">‚è≥ Till nedr√§kning</a>
      <a href="mat-aktiviteter.html">üçú Mat & aktiviteter</a>
    </nav>

    <section class="card">
      <div class="grid">
        <div>
          <label for="vnd">VND (vietnamesiska dong)</label>
          <input id="vnd" inputmode="numeric" autocomplete="off" placeholder="t.ex. 2500000" />
          <div class="hint">Tips: skriv bara siffror. Vi formaterar som <strong>2 500 000</strong>.</div>

          <div class="row">
            <div class="btns">
              <button class="quick-btn" data-add="50000">+50k</button>
              <button class="quick-btn" data-add="100000">+100k</button>
              <button class="quick-btn" data-add="500000">+500k</button>
              <button class="quick-btn" data-add="1000000">+1M</button>
            </div>
          </div>
        </div>

        <div>
          <label for="sek">SEK</label>
          <input id="sek" inputmode="decimal" autocomplete="off" placeholder="t.ex. 100" />
          <div class="hint">Du kan ocks√• skriva SEK s√• r√§knar vi bakl√§nges till VND.</div>

          <div class="row">
            <div class="btns">
              <button id="swap">üîÅ Byt h√•ll</button>
              <button id="copySek">üìã Kopiera SEK</button>
            </div>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="row">
        <div class="btns">
          <button id="refreshRate" class="primary">‚ü≥ Uppdatera kurs</button>
          <button id="useManual">‚úçÔ∏è Manuell kurs</button>
        </div>

        <div class="markup">
          <label for="markupPct">P√•slag (%)</label>
          <input id="markupPct" type="number" inputmode="decimal" min="0" step="0.1" placeholder="t.ex. 1" />
          <div class="hint">Extra kostnad p√• SEK (uttags-/v√§xlingsavgift). <strong>1</strong> = +1%.</div>
        </div>

        <div class="btns">
          <button id="clear">üßπ Rensa</button>
        </div>
      </div>

      <div id="rateInfo" class="rate">H√§mtar v√§xelkurs‚Ä¶</div>
      <div id="toast" class="toast">Kopierat ‚úÖ</div>

      <div class="mini">
        Offline? Vi anv√§nder senast sparad kurs. Du kan alltid s√§tta en manuell kurs.
      </div>
    </section>
  </main>

  <script>
    // ===== Helpers =====
    const fmtIntSpaces = (n) => {
      if (!isFinite(n)) return "";
      const s = Math.round(n).toString();
      return s.replace(/\B(?=(\d{3})+(?!\d))/g, " ");
    };

    const parseNum = (s) => {
      if (!s) return 0;
      const clean = (""+s).replace(/[^\d.,]/g, "").replace(",", ".");
      const n = Number(clean);
      return isFinite(n) ? n : 0;
    };

    const toast = (msg) => {
      const el = document.getElementById("toast");
      el.textContent = msg;
      el.classList.add("show");
      setTimeout(() => el.classList.remove("show"), 1200);
    };

    // ===== Rate (live + cache + manual) =====
    const RATE_KEY = "vnd_sek_rate_cache_v1";
    const MARKUP_KEY = "vnd_sek_markup_pct_v1";
    const DEFAULT_MARKUP_PCT = 1;
    // Vi h√§mtar USD-baserade rates och r√§knar VND->SEK = (SEK/USD) / (VND/USD)
    // K√§lla: open.er-api.com (ingen nyckel beh√∂vs). Exempelendpoint: /v6/latest/USD
    const RATE_URL = "https://open.er-api.com/v6/latest/USD";

    let rateVndToSek = null; // 1 VND -> SEK

    function loadRateCache() {
      try {
        const raw = localStorage.getItem(RATE_KEY);
        return raw ? JSON.parse(raw) : null;
      } catch { return null; }
    }

    function clamp(n, min, max) {
      return Math.min(Math.max(n, min), max);
    }

    function getMarkupPct() {
      if (!markupEl) return DEFAULT_MARKUP_PCT;
      const raw = parseFloat((markupEl.value || "").replace(",", "."));
      if (!Number.isFinite(raw)) return DEFAULT_MARKUP_PCT;
      return clamp(raw, 0, 50);
    }

    function saveMarkupPct(pct) {
      try { localStorage.setItem(MARKUP_KEY, String(pct)); } catch {}
    }

    function loadMarkupPct() {
      try {
        const raw = localStorage.getItem(MARKUP_KEY);
        const n = raw == null ? NaN : parseFloat(raw);
        return Number.isFinite(n) ? clamp(n, 0, 50) : DEFAULT_MARKUP_PCT;
      } catch {
        return DEFAULT_MARKUP_PCT;
      }
    }

    function effectiveRateVndToSek() {
      if (!Number.isFinite(rateVndToSek)) return null;
      return rateVndToSek * (1 + getMarkupPct() / 100);
    }

    function saveRateCache(obj) {
      localStorage.setItem(RATE_KEY, JSON.stringify(obj));
    }

    function setRate(vndToSek, meta) {
      rateVndToSek = vndToSek;
      renderRateInfo(meta);
      recalcFromActive();
    }

    function renderRateInfo(meta = {}) {
      const info = document.getElementById("rateInfo");
      if (!rateVndToSek) {
        info.textContent = "Ingen kurs √§nnu.";
        return;
      }

      const markupPct = getMarkupPct();
      const eff = effectiveRateVndToSek();

      const per1mBase = rateVndToSek * 1_000_000;
      const per1mEff = eff ? eff * 1_000_000 : null;

      const ts = meta.time ? new Date(meta.time) : null;
      const when = ts ? ts.toLocaleString("sv-SE") : (meta.note || "");

      info.innerHTML = `
        <div><strong>1 000 000 VND ‚âà ${per1mEff ? per1mEff.toFixed(2) : per1mBase.toFixed(2)} SEK</strong> <span style="color:#64748b;font-size:.82rem;">(inkl. ${markupPct.toFixed(1)}% p√•slag)</span></div>
        <div style="margin-top:.25rem;color:#64748b;font-size:.82rem;">
          Bas: 1 000 000 VND ‚âà ${per1mBase.toFixed(2)} SEK ‚Ä¢ 1 VND ‚âà ${(rateVndToSek).toFixed(8)} SEK
        </div>
        <div style="margin-top:.25rem;color:#64748b;font-size:.82rem;">
          ${when ? `Senast uppdaterad: ${when}` : ""}
          ${meta.source ? ` ‚Ä¢ K√§lla: ${meta.source}` : ""}
        </div>
      `;
    }

    async function fetchLiveRate() {
      // F√∂r kort laddningstid: en fetch, inga bibliotek.
      const res = await fetch(RATE_URL, { cache: "no-store" });
      if (!res.ok) throw new Error("Kunde inte h√§mta kurs");
      const data = await res.json();
      if (!data || data.result !== "success" || !data.rates) throw new Error("Ogiltigt svar");

      const sekPerUsd = data.rates.SEK;
      const vndPerUsd = data.rates.VND;
      if (!sekPerUsd || !vndPerUsd) throw new Error("Saknar SEK/VND");

      const vndToSek = sekPerUsd / vndPerUsd; // (SEK/USD) / (VND/USD)
      saveRateCache({
        vndToSek,
        time: data.time_last_update_utc || new Date().toISOString(),
        source: "open.er-api.com (USD-baserad)",
        note: ""
      });
      setRate(vndToSek, { time: data.time_last_update_utc, source: "open.er-api.com" });
    }

    function useCachedRateIfAny() {
      const c = loadRateCache();
      if (c && c.vndToSek) {
        setRate(c.vndToSek, { time: c.time, source: c.source || "cache", note: c.note || "" });
        return true;
      }
      return false;
    }

    function setManualRate() {
      const current = rateVndToSek ? rateVndToSek : 0.00004;
      const per1m = current * 1_000_000;
      const input = prompt("Ange manuell kurs som: 1 000 000 VND = ? SEK", per1m.toFixed(2));
      if (input === null) return;
      const sekFor1m = parseNum(input);
      if (sekFor1m <= 0) return alert("Ogiltigt v√§rde.");
      const vndToSek = sekFor1m / 1_000_000;
      saveRateCache({ vndToSek, time: new Date().toISOString(), source: "manuell", note: "Manuellt satt" });
      setRate(vndToSek, { time: new Date().toISOString(), source: "manuell", note: "Manuellt satt" });
    }

    // ===== Conversion logic (two-way) =====
    const vndEl = document.getElementById("vnd");
    const sekEl = document.getElementById("sek");
    const markupEl = document.getElementById("markupPct");
    let active = "vnd"; // vilket f√§lt anv√§ndaren skrev senast

    function formatVndInput() {
      const n = parseNum(vndEl.value);
      vndEl.value = n ? fmtIntSpaces(n) : "";
    }

    function recalcFromVnd() {
      const eff = effectiveRateVndToSek();
      if (!eff) return;
      const vnd = parseNum(vndEl.value);
      const sek = vnd * eff;
      sekEl.value = sek ? sek.toFixed(2) : "";
    }

    function recalcFromSek() {
      const eff = effectiveRateVndToSek();
      if (!eff) return;
      const sek = parseNum(sekEl.value);
      const vnd = sek / eff;
      vndEl.value = vnd ? fmtIntSpaces(vnd) : "";
    }

    function recalcFromActive() {
      if (active === "vnd") { formatVndInput(); recalcFromVnd(); }
      else { recalcFromSek(); }
    }

    vndEl.addEventListener("input", () => {
      active = "vnd";
      // formatera mjukt (utan att hoppa f√∂r mycket)
      const raw = parseNum(vndEl.value);
      vndEl.value = raw ? fmtIntSpaces(raw) : "";
      recalcFromVnd();
    });

    sekEl.addEventListener("input", () => {
      active = "sek";
      recalcFromSek();
      // vi l√•ter SEK vara som anv√§ndaren skriver, men normaliserar till 2 decimaler n√§r man l√§mnar f√§ltet
    });

    sekEl.addEventListener("blur", () => {
      const sek = parseNum(sekEl.value);
      sekEl.value = sek ? sek.toFixed(2) : "";
    });

    // P√•slag (%)
    if (markupEl) {
      markupEl.addEventListener("input", () => {
        const pct = getMarkupPct();
        markupEl.value = String(pct);
        saveMarkupPct(pct);
        recalcFromActive();
        renderRateInfo(loadRateCache() || {});
      });
      markupEl.addEventListener("blur", () => {
        const pct = getMarkupPct();
        markupEl.value = pct.toFixed(1).replace(/\.0$/, "");
      });
    }

    // Quick add buttons
    document.querySelectorAll("button[data-add]").forEach(btn => {
      btn.addEventListener("click", () => {
        active = "vnd";
        const add = Number(btn.getAttribute("data-add")) || 0;
        const current = parseNum(vndEl.value);
        vndEl.value = fmtIntSpaces(current + add);
        recalcFromVnd();
      });
    });

    document.getElementById("swap").addEventListener("click", () => {
      active = (active === "vnd") ? "sek" : "vnd";
      recalcFromActive();
      toast("Bytte h√•ll üîÅ");
    });

    document.getElementById("copySek").addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(sekEl.value || "");
        toast("Kopierat ‚úÖ");
      } catch {
        toast("Kunde inte kopiera");
      }
    });

    document.getElementById("clear").addEventListener("click", () => {
      vndEl.value = "";
      sekEl.value = "";
      active = "vnd";
    });

    document.getElementById("refreshRate").addEventListener("click", async () => {
      try {
        document.getElementById("rateInfo").textContent = "Uppdaterar kurs‚Ä¶";
        await fetchLiveRate();
        toast("Kurs uppdaterad ‚úÖ");
      } catch (e) {
        const ok = useCachedRateIfAny();
        document.getElementById("rateInfo").textContent =
          ok ? "Kunde inte h√§mta live-kurs. Anv√§nder sparad kurs." : "Kunde inte h√§mta kurs.";
      }
    });

    document.getElementById("useManual").addEventListener("click", setManualRate);

    // Init
    (async function init(){
      // Ladda p√•slag fr√•n localStorage
      if (markupEl) {
        const pct = loadMarkupPct();
        markupEl.value = pct.toFixed(1).replace(/\.0$/, "");
      }

      const hadCache = useCachedRateIfAny();
      try {
        await fetchLiveRate(); // autouppdatera (om internet finns)
      } catch {
        if (!hadCache) {
          document.getElementById("rateInfo").textContent =
            "Offline och ingen sparad kurs √§nnu. Tryck ‚ÄúManuell kurs‚Äù f√∂r att s√§tta en kurs.";
        }
      }
    })();
  </script>
</body>
</html>
